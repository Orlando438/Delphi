unit Unit1;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, rest.JSON, Vcl.StdCtrls, IdIOHandler, IdIOHandlerSocket, IdIOHandlerStack,
  IdSSL, IdSSLOpenSSL, IdBaseComponent, IdComponent, IdTCPConnection, IdTCPClient, IdHTTP;

type

Tvariants = class
  private
   Fstock: integer;
   Fprice: string;
   Fgender: string;
   Fbarcode: integer;
   Fweight: string;
   Fwidth: string;
   Fheight: string;
   Fdepth: string;
 public
   property stock: integer read Fstock write Fstock;
   property price: string read Fprice write Fprice;
   property gender: string read Fgender write Fgender;
   property barcode: integer read Fbarcode write Fbarcode;
   property weight: string read Fweight write Fweight;
   property width: string read Fwidth write Fwidth;
   property height: string read Fheight write Fheight;
   property depth: string read Fdepth write Fdepth;
 end;

Tproduto = class
 private
   Fvariants: Tarray<Tvariants>;
 public
   property variants: Tarray<Tvariants> read Fvariants write Fvariants;
 end;

  TForm1 = class(TForm)
    Button1: TButton;
    Memo1: TMemo;
    IdHTTP: TIdHTTP;
    IdSSLIOHandlerSocketOpenSSL: TIdSSLIOHandlerSocketOpenSSL;
    procedure Button1Click(Sender: TObject);
  private
    { Private declarations }
  public
    procedure pesquisar;
  end;

var
  Form1: TForm1;

implementation

{$R *.dfm}

procedure TForm1.Button1Click(Sender: TObject);
begin
  pesquisar;
end;

procedure Tform1.pesquisar;
var
  AURL: String;
  AJsonReturn: TstringStream;
  AListaProduto: Tproduto;
  ARetorno: String;
  i: Integer;
begin
   AURL := 'https://api.tiendanube.com/v1/2933236/products';

  IdSSLIOHandlerSocketOpenSSL.SSLOptions.Method := sslvTLSv1_2;
  IdHTTP.ReadTimeout := 5000;
  IdHTTP.Response.ContentType := 'application/json';
  IdHTTP.Response.Charset := 'UTF-8';
  IdHTTP.Request.CustomHeaders.Values['Authentication'] := 'bearer ab66920be823ba82b281c7289576e35c20d0a1c0';
  IdHTTP.Request.CustomHeaders.Values['User-Agent'] := 'VEXCOM SISTEMAS (suporte@vexcomsistemas.com.br)';

  AJsonReturn := TstringStream.Create();
  try
    IdHTTP.Get(AURL, AJsonReturn);

    ARetorno := AJsonReturn.DataString;
    ARetorno := StringReplace(ARetorno, #10, '', [rfReplaceAll]);
    ARetorno := StringReplace(ARetorno, #13#10, '', [rfReplaceAll]);
    ARetorno := UTF8Decode(ARetorno);

    ARetorno := '{"Result": ' + ARetorno + '}';


    AListaProduto := TJson.JsonToObject<Tproduto>(ARetorno);

    Memo1.Lines.Clear;
    for i := 0 to Length(AListaProduto.Result) -1 do
      Memo1.Lines.Add(AListaProduto.Result[i].name.pt);
  finally
      AJsonReturn.Free;
  end;

end;

end.
